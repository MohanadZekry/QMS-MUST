<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<link rel="shortcut icon" type="image/x-icon" href="images/Logo white.ico" />
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
		<title>QMS Start Service</title>
		<meta name="description" content="A sidebar menu as seen on the Google Nexus 7 website" />
		<meta name="keywords" content="google nexus 7 menu, css transitions, sidebar, side menu, slide out menu" />
		<meta name="author" content="Codrops" />
		<link rel="stylesheet" type="text/css" href="css/normalize.css" />
		<link rel="stylesheet" type="text/css" href="css/demo.css" />
		<link rel="stylesheet" type="text/css" href="css/component.css" />
		<link rel="stylesheet" type="text/css" href="css/medhat.css" />

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-firestore.js"></script>
		 <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-messaging.js"></script>
		<style>
			a:hover{
					color: #007DD7;
				background-color: transparent;
			}
		</style>
	</head>
	<body style="font-family: coves;">
		<script>
			var email = sessionStorage.getItem("mail"); 
		    var password = sessionStorage.getItem("password");
			if (email == null || email == "" ){
			window.location.href= "login.html";
			}
		</script>
<!-- partial -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>

<script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/1.15.0/TweenMax.min.js'></script><script  src="./script.js"></script>
<div style="text-align: center;">
	<div id="load" class="loader" ></div>
	</div>
<div class="container">
	
				<div class="layer">
					<div class="container h-100">
						
						<div class="row justify-content-md-center h-100">
							
							<div class="card-wrapper">
								<div class="brand">

								</div>
								

								<div id="card_con" class="card fat" style="visibility: hidden;">
                                 <div  >
									<div class="card-body" >
										<div style="margin-bottom: 20px;">
										<h4 class="card-title" id="dep-title" ></h4>
										<h4 class="card-title"  > / </h4>
											<h4 class="card-title" id="cat-title" >  </h4>
										</div>
											
												<div class="content" style="text-align: left;" >
													<div class="ticketcard">
													  <div class="firstinfo"><img  src="img/medhat.png">
														<div class="profileinfo">
														  <h1 id="name" ></h1>
														  <h3 id="dep"></h3>
														  <p class="bio" id="id" ></p>
														  
														</div>
													  </div>
													</div>
												  <!--  <div class="badgescard"> <span class="devicons devicons-django"></span><span class="devicons devicons-python"> </span><span class="devicons devicons-codepen"></span><span class="devicons devicons-javascript_badge"></span><span class="devicons devicons-gulp"></span><span class="devicons devicons-angular"></span><span class="devicons devicons-sass"> </span></div>-->
												  </div>
													
												
										
										<div style="text-align: center;">
									 
											<div class="card-body">
											
												<div class="card-title" id="copy">
													<div>
													<h4 aria-valuetext="1" >Current Ticket: <b id="numt" > </b></h4>
													</div>
													
												</div>
												<form method="POST" class="my-login-validation" novalidate="">
													<div class="card-title" id="copy"><h5 >Remaining: <b id="numr">--</b></h5></div>
					
													<div class="form-group m-0">
														<button  type="button" class="nextbutton" id="get-next">
															Get Next One
														</button>
													</div>
												</form>
											</div>
											
										</div>
									</div>
                                  </div>
								</div>
								
								</div>

								
								
								
								
							</div>
						</div>
					</div>
				</div>
					

			<ul id="gn-menu" class="gn-menu-main">
				<li class="gn-trigger">
					<a class="gn-icon gn-icon-menu"><span>Menu</span></a>
					<nav class="gn-menu-wrapper">
						<div class="gn-scroller">
							<ul class="gn-menu">
								<li><a class="gn-icon gn-icon-download" href="dashboard.html">Dashboard</a></li>
										<li><a class="gn-icon gn-icon-illustrator" href="start.html">Start Service</a></li>
										<li><a class="gn-icon gn-icon-photoshop" href="addtime.html">Add Time</a></li>
									<li><a class="gn-icon gn-icon-manual" href="manual.html">Manual</a></li>
								<li><a class="gn-icon gn-icon-archive" href="index.html">About QMS</a></li>
								<ul class="gn-submenu">
								<li><a class="gn-icon gn-icon-cog">Settings</a></li>
								<li><a class="gn-icon gn-icon-help">Help</a></li>
								
						    	</ul>
							</ul>
							<div class="footer">
								<div  id="copy"><a style="color: #666666;"  href="" target="_blank">All Rights Reserved to: <b>INTEGRITYÂ©</b></a></div>
							</div>
						</div><!-- /gn-scroller -->
					</nav>
				</li>
				<li><a class="gn-icon gn-icon-logout" href="login.html" onclick="myFunction()">Logout</a></li>
				
			</ul>
					
		</div>
	

			
	
		<script src="js/classie.js"></script>
		<script src="js/gnmenu.js"></script>
		<script>
			new gnMenu( document.getElementById( 'gn-menu' ) );
		</script>
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
			  apiKey: "AIzaSyAu2RaUIww5TWUnuwg1nBWTkuft1IVPn4Y",
			  authDomain: "qms-f137a.firebaseapp.com",
			  databaseURL: "https://qms-f137a.firebaseio.com",
			  projectId: "qms-f137a",
			  storageBucket: "qms-f137a.appspot.com",
			  messagingSenderId: "1036646415502",
			  appId: "1:1036646415502:web:64d51a6d915d68f2569ddf",
			  measurementId: "G-F28BV22X15"
			};


			var department = sessionStorage.getItem("department"); 
		    var category = sessionStorage.getItem("category");
			var email = sessionStorage.getItem("mail"); 
		    var password = sessionStorage.getItem("password");

			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			const db= firebase.firestore();
			
			
			firebase.auth.Auth.Persistence.LOCAL; 
    
            var result = firebase.auth().signInWithEmailAndPassword(email,password);
    
                result.catch(function(error){
             var errorCode = error.code; 
             var errorMessage = error.message; 

        console.log(errorCode);
        console.log(errorMessage);
    });

	     
		  console.log(department);
		  console.log(category);
		  document.getElementById("dep-title").textContent= department;
		  document.getElementById("cat-title").textContent= category;

		  var docRef = db.collection("queueNumber").doc("Receive Books").collection("B").doc("currentTicket");
		  var docRem = db.collection("services").doc("Receive Books").collection("B");
		  var docRefemp = db.collection("queueNumber").doc("Receive Books").collection("B").doc("currentTicket").collection("EmployeecurrentTicket").doc(email);
          console.log("email",email);
		  

		  docRef.onSnapshot(function(doc) {
			rem = (doc.data().totalTickets) -(doc.data().number);
			 
			  document.getElementById("numr").textContent=rem+1;
			  

		   });


		  docRefemp.get().then(function(doc) {
			   nemp = doc.data().number;

			docRef.get().then(function(docc) {
			
			if ((docc.data().number) == (docc.data().totalTickets)+1){
			}
			else {
				num = docc.data().number;
			console.log("empnum",nemp);
			console.log("num",num);
			var next = (docc.data().number)+1;
						if ((docc.data().number) < (docc.data().totalTickets)){
							docRef.update({
									number: next
								});
								nemp = num;
								console.log("iff");
							}
			docRem.where("ticket_number", "==", nemp)
                 .get()
                 .then(function(querySnapshot) {
                  querySnapshot.forEach(function(doccc) {
					document.getElementById("numt").textContent= nemp;
					console.log(doccc.id, " => ", doccc.data());
					
					document.getElementById("name").textContent= doccc.data().name;
					document.getElementById("id").textContent= doccc.data().user_id;
					document.getElementById("dep").textContent= doccc.data().department;
					document.getElementById("load").style.visibility = 'hidden' ;
					document.getElementById("card_con").style.visibility = 'visible' ;
					if ((docc.data().number) < (docc.data().totalTickets)){
							
								docRefemp.update({
									number: next
									
								});
								nemp = next;
								console.log("if");
							}
				 		});
			
		   });
		}
		   });
		   
		   });
///////////////////

		   document.getElementById("get-next").onclick=function(){
			document.getElementById("load").style.visibility = 'visible' ;
			docRefemp.get().then(function(doc) {
			   nemp = doc.data().number;

			docRef.get().then(function(docc) {
			
			if ((docc.data().number) == (docc.data().totalTickets)+1){
			}
			else {
				num = docc.data().number;
			console.log("empnum",nemp);
			console.log("num",num);
			var next = (docc.data().number)+1;
						if ((docc.data().number) < (docc.data().totalTickets)){
							docRef.update({
									number: next
								});
								nemp = num;
								console.log("iff");
							}
			docRem.where("ticket_number", "==", nemp)
                 .get()
                 .then(function(querySnapshot) {
                  querySnapshot.forEach(function(doccc) {
					document.getElementById("numt").textContent= nemp;
					console.log(doccc.id, " => ", doccc.data());
					
					document.getElementById("name").textContent= doccc.data().name;
					document.getElementById("id").textContent= doccc.data().user_id;
					document.getElementById("dep").textContent= doccc.data().department;
					document.getElementById("load").style.visibility = 'hidden' ;
					document.getElementById("card_con").style.visibility = 'visible' ;
					if ((docc.data().number) < (docc.data().totalTickets)){
							
								docRefemp.update({
									number: next
									
								});
								nemp = next;
								console.log("if");
							}
				 		});
			
		   });
		}
		   });
		   
		   });
/////////

docRem.where("ticket_number", "==", num+3)
                 .get()
                 .then(function(querySnapshot) {
                  querySnapshot.forEach(function(doc) {
                  
				  var token= doc.data().user_token;
				  var estimateWaitingTime =(parseInt(doc.data().service_time)*3);
                  
var to = [token];
var n = doc.data().ticket_number;
var name = doc.data().name;
var f_name = name.split(' ')[0];
document.getElementById("name").textContent = estimateWaitingTime;	
var stringWait = estimateWaitingTime+"";
$.ajax({
	type: 'POST',
	url: 'https://fcm.googleapis.com/fcm/send', 
	headers:{
		Authorization: 'key=AAAA8Vzw_I4:APA91bE9CrQjbGj6BKaFXHPyxjwBSm7TtQRhRgQRfgJ6woJE24dAKK_SSpWdPSjvrrE1cezWd825SaUXplvphUPiF0jkM4rwcH3XF7bm9-l4DQVry3LHBBaaB9gohNH3vhxZjTikqF9Y'
	},
	contentType: 'application/json',
	dataType: 'json',
	data: JSON.stringify({
		"registration_ids":to,
		"notification":{
			"title": department+" Ticket",
			"body": (f_name+" Be there after "+stringWait+" mins"),
      			"sound": "default"
		}
	}),
	success: function(response){
		
	},
	error: function(error){
		
		alert("Some error occurred");
	}
});



        });
    })
    .catch(function(error) {
        console.log("Error getting documents: ", error);
	});	
	//location.reload();
		};

/////////////////////
		  
		 
				  
				  
	 


			  $("#get-next").click(function(){


});
			  

	
		  </script>
		  <script src="js/myscript.js"></script>
	</body>
</html>
