<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8" />
		<link rel="shortcut icon" type="image/x-icon" href="images/Logo white.ico" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
		<title>Edit Time</title>
		<meta name="description" content="A sidebar menu as seen on the Google Nexus 7 website" />
		<meta name="keywords" content="google nexus 7 menu, css transitions, sidebar, side menu, slide out menu" />
		<meta name="author" content="Codrops" />
		<link rel="stylesheet" type="text/css" href="css/normalize.css" />
		<link rel="stylesheet" type="text/css" href="css/demo.css" />
		<link rel="stylesheet" type="text/css" href="css/component.css" />
		<link rel="stylesheet" type="text/css" href="css/medhat.css" />



		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
		 <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-firestore.js"></script>
	 
		<style>
			a:hover{
				color: #007DD7;
				background-color: transparent;
				
			}
			@font-face {
    font-family: digital_number_font;
    src: url(font/digital_number_font.ttf);
  }
  @font-face {
    font-family: cairo_font;
    src: url(font/cairo_regular.ttf);
  }
		</style>
	</head>
	<body style="font-family: coves;">
		<script>
			var email = sessionStorage.getItem("mail"); 
		    var password = sessionStorage.getItem("password");
			if (email == null || email == "" ){
			window.location.href= "login.html";
			}
		</script>
<!-- partial -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/1.15.0/TweenMax.min.js'></script><script  src="./script.js"></script>
		<div class="container">
				<div class="layer">
					<div class="container h-100">
						<div class="row justify-content-md-center h-100">
							<div class="card-wrapper-Manual">
								<div class="brand">
									
								</div>
								<div class="card fat" >
									<div class="card-body">
										<div class="content" style="text-align: left;" >
											<div class="ticketcard-Manual">
											  <div class="firstinfo"><img  src="img/iconfinder_printer_531905.png">
												<div class="profileinfo">
													<form method="post" style="padding: 8px;">
														<div>
															<input type="text" id="user_id" name="fname"><br><br>
														</div>
														<div   style="  text-align: center;">
														<select  id="ddm_categories"></select>	
														
													</div>								
												</div>
												<button style="padding: 8px;  margin: auto;" class="nextbutton" type="button" id = "button-ticket">Get Ticket</button>
											</form>
											</div>
											</div>
										  </div>										  
									</div>									
								</div>
							</div>						
						</div>					
					</div>
				</div>
				
			<ul id="gn-menu" class="gn-menu-main">
				<li class="gn-trigger">
					<a class="gn-icon gn-icon-menu"><span>Menu</span></a>
					<nav class="gn-menu-wrapper">
						<div class="gn-scroller">
							<ul class="gn-menu">
								<li><a class="gn-icon gn-icon-download" href="dashboard.html">Dashboard</a></li>
										<li><a class="gn-icon gn-icon-illustrator" href="start.html">Start Service</a></li>
										<li><a class="gn-icon gn-icon-photoshop" href="addtime.html">Add Time</a></li>	
										<li><a class="gn-icon gn-icon-manual" href="manual.html">Manual</a></li>								
								<li><a class="gn-icon gn-icon-archive" href="index.html">About QMS</a></li>
								<ul class="gn-submenu">
								<li><a class="gn-icon gn-icon-cog">Settings</a></li>
								<li><a class="gn-icon gn-icon-help">Help</a></li>
						    	</ul>
							</ul>
							<div class="footer">
								<div  id="copy"><a style="color: #666666;"  href="" target="_blank">All Rights Reserved to: <b>INTEGRITYÂ©</b></a></div>
							</div>									
						</div><!-- /gn-scroller -->
					</nav>
				</li>
				<li><a class="gn-icon gn-icon-logout" href="login.html" onclick="myFunction()">Logout</a></li>
				
            </ul>
		</div>
	

			
	
		<script src="js/classie.js"></script>
		<script src="js/gnmenu.js"></script>
		<script>
			new gnMenu( document.getElementById( 'gn-menu' ) );
		</script>

	
	
	<script>
		new gnMenu( document.getElementById( 'gn-menu' ) );
	</script>
	<script>
			var options = "";

var request = new XMLHttpRequest();
request.open('GET', 'https://addmission.must.edu.eg/QMSAPI/api/TimeTable/GetCategoryByDay/Clinics', true);
request.onload = function () {


  // Begin accessing JSON data here
  var data = JSON.parse(this.response);
  if (request.status >= 200 && request.status < 400) {
	var $select = $('#ddm_categories');

    	data.forEach(categories => {
		var group = $('<optgroup label="' + categories.categoryName + '" />');

		categories.categoryObj.forEach(categoryObjValue =>{

			$('<option />').html(categoryObjValue.categoryObjName).appendTo(group);

		});
        group.appendTo($select);	  
	});
  } else {

    const errorMessage = document.createElement('marquee');
    errorMessage.textContent = `Gah, it's not working!`;
	console.log(errorMessage);

    app.appendChild(errorMessage);
  }
}
request.send();


		// Your web app's Firebase configuration
		var firebaseConfig = {
		  apiKey: "AIzaSyAu2RaUIww5TWUnuwg1nBWTkuft1IVPn4Y",
		  authDomain: "qms-f137a.firebaseapp.com",
		  databaseURL: "https://qms-f137a.firebaseio.com",
		  projectId: "qms-f137a",
		  storageBucket: "qms-f137a.appspot.com",
		  messagingSenderId: "1036646415502",
		  appId: "1:1036646415502:web:64d51a6d915d68f2569ddf",
		  measurementId: "G-F28BV22X15"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		const db= firebase.firestore();
		
		  
			  document.getElementById("button-ticket").onclick=function(){

				
        			var label=$('#ddm_categories :selected').parent().attr('label');
    				var category = label;
				
					var userID = document.getElementById('user_id').value;
					var name = 'Manual';
					var currentDate = new Date();
					var date = currentDate.getDate();
					var month = currentDate.getMonth(); 
					var year = currentDate.getFullYear();
					
					var monthDateYear  = (month+1) + "/" + date + "/" + year+" - "+ currentDate.getHours() + ":"+ currentDate.getMinutes()+":"+ currentDate.getSeconds();					
					var docRef = db.collection("queueNumber").doc('Clinics').collection(category).doc("currentTicket");
					var docReg = db.collection("servicesDetails").doc('Clinics');
					
					

					docRef.get().then(function(doc) {
					if (doc.exists) {
						var windowTicket = doc.data().number;
						var	currentTicket = (doc.data().totalTickets)+1;
						var remaining = currentTicket - windowTicket;
					docRef.update({
					"totalTickets": currentTicket
					  });
					  docReg.get().then(function(doc2) {
						var estimateTime = doc2.data().time;
						

					var docRem = db.collection("services").doc('Clinics').collection(category)
					.add({
					department: category,
					name: "Manual",
					service_window : windowTicket,
					user_id : userID,
					ticket_number : currentTicket,
					service_time : estimateTime,
					user_token : '',
					date : monthDateYear
		})
.then(function() {
	console.log("Document successfully written!");
	sessionStorage.setItem("user_id", userID);
	sessionStorage.setItem("ticket_number", currentTicket);
	sessionStorage.setItem("date", monthDateYear);
	sessionStorage.setItem("time", (estimateTime*remaining));
	sessionStorage.setItem("remaining", remaining);

	window.open("print.html");

})
.catch(function(error) {
    console.error("Error writing document: ", error);
});
});
} else {
						// doc.data() will be undefined in this case
						console.log("No such document!");
					}
					}).catch(function(error) {
						console.log("Error getting document:", error);
					});
	  };
	 


	  </script>		
	  <script src="js/myscript.js"></script>
	  
	</body>
</html>
